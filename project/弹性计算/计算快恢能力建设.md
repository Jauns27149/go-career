#  快恢复三板斧

​	云主机常见的问题，以及该问题产生的原因，附带快速排查问题的shell脚本使用详情。

- 常见问题
  - 卡顿
  - 备份异常
  - 快照异常
  - 修改密码失败
  - 远程连接失败
- 快速排查脚本
  - 4.0 gs-scan
  - 3.0 nove-scan
  - ctops

## 常见问题

### 云主机卡顿

 	可能由以下原因造成：

- 本地网络异常
- 网络链路存在丢包或延迟高的情况
- 实例CPU、内存、宽带使用过高
- 服务器负载引起资源消耗增大
- 云盘到期限速检测

#### 本地网络异常

- 排查DNS: 使用 ip 地址看是否能接通

  ```bash
  ping -c 4 "$IP_ADDRESS"
  ```

#### 网络链路存在丢包或延迟高的情况

- 网络丢包

  ```bash
  ping -c 4 url
  ```

- 带宽使用率高

  ```bash
  ip a // 查看主机所以网络端口名称eth
  sudo nethogs [eth1] // 查看指定的网络端口每个进程的网络带宽使用情况
  ```

#### 实例CPU 、内存、宽带使用过高

- top 命令查看 CPU、内存情况

  ```bash
  top
  ```

### 备份异常

​	可能由以下原因造成：

- Libvirt 版本冲突
- 备份策略冲突
- QGA 异常
- 备份超时（云主机状态异常）
- 云主机无法开机
- 备份镜像错误
- 备份时间过长（cinder的优化）
- 云主机备份卡状态
- 存储空间超限，自动备份失效
- 云硬盘备份和云快照冲突
- 虚机转镜像和快照冲突
- 删除卡中间状态
- 宿主机down

#### libvirt 版本问题

​	备份节点的librbd版本为14.2.7版本以上。

```bash
# 执行ceph --version命令，并通过管道传递给awk处理  
ceph_version=$(ceph --version | awk '{print $3}' | cut -d'-' -f1)  
```

#### 备份策略冲突(cinder)

- 创建和删除的策略先后下发，删除备份时创建未完成，因磁盘状态冲突(in-use)导致删除失败；同时删除策略不再触发失败备份的删除，导致后续不再删除该备份
- 超过快照配额后不再能继续创建，由于客户快照策略的保留个数为7个，当前自动快照为6个，手动创建1个，所以不会触发删除，但是下游在计算配额时，会将用户手动和自动创建的快照均计算配额，所以返回了 配额超限的问题（非底层问题）（贵斌）

#### QGA异常导致

1. 在宿主上查看qga是否连接：virsh dumpxml vm-uuid | grep qemu.guest_agent | grep connected; 若没有连接，则看下什么镜像，找客户授权登陆机器内部查看qga的情况（是否禁用，是否卸载等）；
2. 若qga connected，则尝试发送命令验证qga/sync功能是否ok：不正常，找客户授权登陆机器内部查看qga的情况。

```bash
# 尝试恢复QGA服务
status=$(systemctl status $service_name --no-pager | grep -o 'active \(running\)' || true)
```

### 快照异常

​	可能由以下原因造成：

- QGA异常
- 异常快照重装失败
- 云主机关机同步状态显示快照创建中
- 云主机处于异常状态
- 快照策略设置异常
- 券状态异常
- 快照配额冲突
- 备份状态冲突
  

#### 快照失败问题

```bash
gs instance snapshot-list
gs instance snapshot-show 9b0f7c4a-429f-9b18-8b0d-28fa7387c72d
```

### 修改密码失败

​	可能由以下原因造成：

- QGA失联/QGA服务异常
- 无法重置密码
- 系统盘损坏（cinder/虚拟化）

### 远程连接失败

​	这里说的远程连接失败，主要是说Linux的SSH连接失败。可能由以下原因造成：

- 云主机资源状态不可用
- 云主机负载过高
- 杀毒软件拦截
- SSH配置异常
- 网络不可用

## 云主机通用检查工具

- 4.0 gs-scan
- 3.0 nove-scan
- ctops

[命令思维导图](https://docs.qq.com/aio/DQ0ZLZk1zUlpNaEJa?u=2d70b4c64f69417bb6c1a9f3589083eb&p=ayWdrVsI2ZXZSXHSQdFbgQ)

# 问题反馈

1. 工单应该是提供主机 id 的，怎么通过虚拟机 id 进入宿主机。
2. 介绍了3个检查问题的脚本工具，他们应该迭代的关系，实际排查中是否只用 gs-scan。
3. 

